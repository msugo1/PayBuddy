openapi: 3.0.3
info:
  title: PayBuddy Payment API
  version: 1.0.0
  description: |
    PayBuddy 결제 도메인 API

    - 단일/복합 결제
    - 정기결제 (빌링키)
    - 결제 취소 및 환불
    - 차지백 및 분쟁 처리
    - Webhook 이벤트 수신
  contact:
    name: PayBuddy API Support
    email: api@paybuddy.com

servers:
  - url: https://api.paybuddy.com/v1
    description: Production
  - url: https://sandbox-api.paybuddy.com/v1
    description: Sandbox

security:
  - ApiKeyAuth: []
  - BearerAuth: []

tags:
  - name: Payments
    description: 결제 요청 및 조회
  - name: Composite Payments
    description: 복합 결제 (여러 결제수단 조합)
  - name: Recurring Payments
    description: 정기결제 (빌링키 기반)
  - name: Cancellations
    description: 결제 취소 및 환불
  - name: Chargebacks
    description: 차지백 및 분쟁 처리
  - name: Webhooks
    description: Webhook 이벤트 수신

paths:
  /payments/ready:
    post:
      tags:
        - Payments
      summary: 결제 준비 (세션 생성)
      description: |-
        결제 세션을 생성합니다.

        - 아직 승인(Authorization)은 수행하지 않습니다.
        - 동일한 `Idempotency-Key`로 **동일 요청**을 반복 호출하면 성공(멱등) 처리됩니다.
        - 동일한 `Idempotency-Key`로 **다른 요청 본문**을 보내면 `409 Conflict`를 반환합니다.
      operationId: readyPayment
      parameters:
        - name: Idempotency-Key
          in: header
          required: true
          description: 멱등성 키. 동일 키로 동일 요청이면 재시도 가능. 동일 키로 다른 요청이면 409.
          schema:
            type: string
            example: idem_6f0f2e0d-2e91-4d0d-9c3d-1b6e2c0f8d9a
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '../schemas/payment.yaml#/PaymentReadyRequest'
      responses:
        '201':
          description: 준비 성공
          content:
            application/json:
              schema:
                $ref: '../schemas/payment.yaml#/PaymentReadyResponse'
        '400':
          description: 잘못된 요청
          content:
            application/problem+json:
              schema:
                $ref: '../error.yaml#/ErrorResponse'
              examples:
                missing_order_id:
                  summary: order_id 누락
                  value:
                    type: 'about:blank'
                    title: 'Request Field does not conform to the API contract'
                    status: 400
                    error_code: 'INVALID_REQUEST_FIELD'
                    instance: '/payments/ready'
                    errors:
                      order_id: ['must not be blank']
        '401':
          description: 인증 실패
          content:
            application/problem+json:
              schema:
                $ref: '../error.yaml#/ErrorResponse'
        '409':
          description: 이전 요청과의 충돌 발생 (멱등성 위반)
          content:
            application/problem+json:
              schema:
                $ref: '../error.yaml#/ErrorResponse'
              examples:
                idempotency_conflict:
                  summary: 동일한 멱등성 키로 다른 내용의 요청이 들어온 경우
                  value:
                    type: 'about:blank'
                    title: 'Idempotency conflict'
                    status: 409
                    detail: 'The request payload does not match the original request associated with this idempotency key'
                    instance: '/payments/ready'
                    error_code: 'IDEMPOTENCY_CONFLICT'

  /payments/confirm:
    post:
      tags:
        - Payments
      summary: 결제 진행 (승인/매입확정 통합)
      description: |-
        결제를 진행합니다. 서버가 현재 상태(status)에 따라 동작을 결정합니다.

        - status=INITIALIZED 또는 PENDING: 승인(Authorize)을 수행
          - 서버 정책에 따라:
            - AUTHORIZED: 가승인(Preauthorize) 완료 (추후 재호출로 매입확정)
            - CAPTURED: 승인과 동시에 매입 확정(즉시 결제)
        - status=AUTHORIZED: 매입 확정(Capture)을 수행 → CAPTURED

        클라이언트는 void/cancel처럼 세부 동작을 선택할 필요가 없으며,
        동일 엔드포인트 재호출로 흐름을 진행합니다.
      operationId: confirmPayment
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: '../schemas/payment.yaml#/PaymentConfirmRequest'
      responses:
        '200':
          description: 진행 결과
          content:
            application/json:
              schema:
                $ref: '../schemas/payment.yaml#/PaymentConfirmResponse'
        '400':
          description: 잘못된 요청
          content:
            application/problem+json:
              schema:
                $ref: '../error.yaml#/ErrorResponse'
        '401':
          description: 인증 실패
          content:
            application/problem+json:
              schema:
                $ref: '../error.yaml#/ErrorResponse'
        '422':
          description: 처리할 수 없는 요청
          content:
            application/problem+json:
              schema:
                $ref: '../error.yaml#/ErrorResponse'

  /payments/{payment_key}:
    get:
      tags:
        - Payments
      summary: 결제 상세 조회 (운영/관리자용)
      description: |-
        가맹점 및 운영자가 결제 상세 정보를 조회합니다.
        - 민감정보 포함 (수수료, 정산금액 등)
        - API Key 인증 필요
      operationId: getPayment
      parameters:
        - name: payment_key
          in: path
          required: true
          schema:
            type: string
          description: 결제 고유키
      responses:
        '200':
          description: 조회 성공
          content:
            application/json:
              schema:
                $ref: '../schemas/payment.yaml#/PaymentResponse'
        '404':
          description: 리소스를 찾을 수 없음
          content:
            application/problem+json:
              schema:
                $ref: '../error.yaml#/ErrorResponse'

  /payments/{payment_key}/receipt:
    get:
      tags:
        - Payments
      summary: 결제 영수증 조회 (소비자용)
      description: |-
        소비자가 결제 영수증을 조회합니다.
        - 민감정보 최소화 (수수료 제외, 카드번호 강한 마스킹)
        - 공개 가능 (토큰 기반 인증)
        - PDF/HTML 형식 지원
      operationId: getPaymentReceipt
      parameters:
        - name: payment_key
          in: path
          required: true
          schema:
            type: string
        - name: format
          in: query
          schema:
            type: string
            enum:
              - json
              - pdf
              - html
            default: json
          description: 응답 형식
      responses:
        '200':
          description: 영수증 조회 성공
          content:
            application/json:
              schema:
                $ref: '../schemas/payment.yaml#/ReceiptResponse'
            application/pdf:
              schema:
                type: string
                format: binary
            text/html:
              schema:
                type: string

  /payments/composite:
    post:
      tags:
        - Composite Payments
      summary: 복합 결제 요청
      description: |-
        여러 결제수단을 조합하여 결제를 진행합니다.
        - 카드 + 카드
        - 카드 + 포인트
        - 부분 성공/실패 처리
      operationId: createCompositePayment
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '../schemas/payment.yaml#/CreateCompositePaymentRequest'
      responses:
        '201':
          description: 복합 결제 생성 성공
          content:
            application/json:
              schema:
                $ref: '../schemas/payment.yaml#/CompositePaymentResponse'

  /payments/retry:
    post:
      tags:
        - Composite Payments
      summary: 복합 결제 재시도
      description: |-
        복합 결제 중 실패한 항목을 재시도합니다.
        - 특정 항목만 선택 가능
        - 결제수단 변경 가능
        - 30분 이내: 저장된 토큰으로 재시도 가능
        - 30분 이후: 카드 정보 재입력 필요
      operationId: retryPayment
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '../schemas/payment.yaml#/RetryPaymentRequest'
      responses:
        '200':
          description: 재시도 성공
          content:
            application/json:
              schema:
                $ref: '../schemas/payment.yaml#/CompositePaymentResponse'

  /payments/billing:
    post:
      tags:
        - Recurring Payments
      summary: 빌링키 결제 실행
      description: |-
        발급된 빌링키로 결제를 실행합니다.
        - 고객 개입 없이 자동 결제
      operationId: chargeWithBillingKey
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '../schemas/payment.yaml#/BillingPaymentRequest'
      responses:
        '200':
          description: 빌링 결제 성공
          content:
            application/json:
              schema:
                $ref: '../schemas/payment.yaml#/PaymentResponse'

  /billing-keys:
    post:
      tags:
        - Recurring Payments
      summary: 빌링키 발급 요청
      description: |-
        정기결제를 위한 빌링키를 발급받습니다.
        - 최초 강한 인증(SCA) 필요
        - 카드 정보 암호화 저장
      operationId: createBillingKey
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '../schemas/payment.yaml#/CreateBillingKeyRequest'
      responses:
        '201':
          description: 빌링키 발급 성공
          content:
            application/json:
              schema:
                $ref: '../schemas/payment.yaml#/BillingKeyResponse'

  /payments/cancel:
    post:
      tags:
        - Cancellations
      summary: 결제 취소
      description: |-
        [상태 기반 취소 동작]
        - status=AUTHORIZED(가승인): 승인취소(Authorization reversal)로 처리되어 status=VOIDED가 됩니다.
        - status=CAPTURED/APPROVED(매입 완료): 환불/취소로 처리되어 status=CANCELED 또는 PARTIAL_CANCELED가 됩니다.

        결제를 취소합니다 (단일/복합 결제 모두 지원)

        **단일 결제**:
        - cancel_amount 생략: 전체 취소
        - cancel_amount 지정: 부분 취소
        - cancel_items는 무시됨

        **복합 결제 전체 취소**:
        - cancel_items 생략: 모든 항목 전체 취소
        - cancel_amount는 무시됨

        **복합 결제 부분 취소**:
        - cancel_items 지정: 해당 항목만 취소
        - 각 항목별로 전액/부분 취소 가능

        **비즈니스 규칙**:
        - 취소 금액은 남은 금액을 초과할 수 없음
        - 가상계좌 결제 취소 시 refund_account 필수
        - 복합 결제에서 모든 항목이 취소되면 자동으로 CANCELED 상태로 전환
      operationId: cancelPayment
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '../schemas/payment.yaml#/CancelPaymentRequest'
            examples:
              single_full:
                summary: 단일 결제 전체 취소
                value:
                  cancel_reason: 고객 요청
              single_partial:
                summary: 단일 결제 부분 취소
                value:
                  cancel_amount: 20000
                  cancel_reason: 일부 환불
              composite_full:
                summary: 복합 결제 전체 취소
                value:
                  cancel_reason: 주문 취소
              composite_partial_items:
                summary: 복합 결제 특정 항목 전체 취소
                value:
                  cancel_items:
                    - sub_payment_id: sub_1
                  cancel_reason: 신한카드 결제분만 환불
              composite_partial_amount:
                summary: 복합 결제 특정 항목 부분 취소
                value:
                  cancel_items:
                    - sub_payment_id: sub_1
                      cancel_amount: 30000
                  cancel_reason: 일부 환불
              composite_multiple:
                summary: 복합 결제 여러 항목 취소
                value:
                  cancel_items:
                    - sub_payment_id: sub_1
                      cancel_amount: 20000
                    - sub_payment_id: sub_2
                  cancel_reason: 복합 환불
      responses:
        '200':
          description: 취소 성공
          content:
            application/json:
              schema:
                $ref: '../schemas/payment.yaml#/CancelPaymentResponse'

  /chargebacks:
    get:
      tags:
        - Chargebacks
      summary: 차지백 목록 조회
      description: 가맹점의 차지백 목록을 조회합니다.
      operationId: getChargebacks
      parameters:
        - name: status
          in: query
          schema:
            type: string
            enum:
              - PENDING
              - UNDER_REVIEW
              - MERCHANT_WIN
              - MERCHANT_LOSE
        - name: page
          in: query
          schema:
            type: integer
            default: 1
        - name: size
          in: query
          schema:
            type: integer
            default: 20
      responses:
        '200':
          description: 조회 성공
          content:
            application/json:
              schema:
                $ref: '../schemas/payment.yaml#/ChargebacksResponse'

  /chargebacks/{chargeback_id}:
    get:
      tags:
        - Chargebacks
      summary: 차지백 상세 조회
      operationId: getChargeback
      parameters:
        - name: chargeback_id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: 조회 성공
          content:
            application/json:
              schema:
                $ref: '../schemas/payment.yaml#/ChargebackDetailResponse'

  /chargebacks/{chargeback_id}/dispute:
    post:
      tags:
        - Chargebacks
      summary: 차지백 이의제기
      description: |-
        차지백에 대한 증빙 자료를 제출합니다.
        - 배송 증명
        - 거래 로그
        - 본인 인증 기록
      operationId: disputeChargeback
      parameters:
        - name: chargeback_id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '../schemas/payment.yaml#/DisputeChargebackRequest'
      responses:
        '200':
          description: 이의제기 접수 성공
          content:
            application/json:
              schema:
                $ref: '../schemas/payment.yaml#/DisputeChargebackResponse'

  /webhooks/payments:
    post:
      tags:
        - Webhooks
      summary: 결제 웹훅 수신
      description: |-
        카드사/은행으로부터 결제 결과를 수신합니다.
        - 승인 완료
        - 결제 실패
        - 가상계좌 입금 완료
      operationId: receivePaymentWebhook
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '../schemas/payment.yaml#/PaymentWebhookEvent'
      responses:
        '200':
          description: 수신 성공

  /webhooks/chargebacks:
    post:
      tags:
        - Webhooks
      summary: 차지백 웹훅 수신
      description: |-
        카드사로부터 차지백 알림을 수신합니다.
        - 차지백 발생
        - 차지백 결정
      operationId: receiveChargebackWebhook
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '../schemas/payment.yaml#/ChargebackWebhookEvent'
      responses:
        '200':
          description: 수신 성공

components:
  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: X-API-Key
      description: 가맹점 API Key
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT 토큰 (내부 서비스용)
